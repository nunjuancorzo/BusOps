@inherits LayoutComponentBase
@using BusOps.Data
@using BusOps.Models
@using Microsoft.EntityFrameworkCore
@inject NavigationManager NavigationManager
@inject IDbContextFactory<BusOpsDbContext> DbFactory

<div class="page">
    @if (!NavigationManager.Uri.EndsWith("/login"))
    {
        <NavMenu />
    }

    <main>
        <article class="content px-4">
            @Body
        </article>
    </main>

    @if (!NavigationManager.Uri.EndsWith("/login"))
    {
        <footer class="text-center py-4 mt-4 border-top" style="background-color: #f5f5f5;">
            <div class="container">
                @if (configuracionEmpresa != null)
                {
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <h6 class="fw-bold text-purple mb-2">@configuracionEmpresa.NombreEmpresa</h6>
                            <p class="text-muted mb-1"><small>NIF: @configuracionEmpresa.NIF</small></p>
                            <p class="text-muted mb-0"><small>@configuracionEmpresa.Direccion</small></p>
                            <p class="text-muted mb-0"><small>@configuracionEmpresa.CodigoPostal @configuracionEmpresa.Ciudad, @configuracionEmpresa.Provincia</small></p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="fw-bold text-purple mb-2">Contacto</h6>
                            <p class="text-muted mb-1">
                                <i class="bi bi-telephone"></i> <small>@configuracionEmpresa.Telefono</small>
                            </p>
                            <p class="text-muted mb-1">
                                <i class="bi bi-envelope"></i> <small>@configuracionEmpresa.Email</small>
                            </p>
                            @if (!string.IsNullOrEmpty(configuracionEmpresa.Web))
                            {
                                <p class="text-muted mb-0">
                                    <i class="bi bi-globe"></i> <small>@configuracionEmpresa.Web</small>
                                </p>
                            }
                        </div>
                        <div class="col-md-4">
                            <h6 class="fw-bold text-purple mb-2">Información Legal</h6>
                            <p class="text-muted mb-0">
                                <small>
                                    Todos los datos de esta aplicación son privados y confidenciales. 
                                    La información aquí contenida está protegida bajo las leyes de protección de datos vigentes.
                                </small>
                            </p>
                        </div>
                    </div>
                }
                <hr style="border-color: #dee2e6;" />
                <div class="mb-2">
                    <small>
                        <a href="/proteccion-datos" class="text-muted text-decoration-none me-3">
                            <i class="bi bi-shield-lock"></i> Protección de Datos
                        </a>
                        <a href="/politica-cookies" class="text-muted text-decoration-none">
                            <i class="bi bi-cookie"></i> Política de Cookies
                        </a>
                    </small>
                </div>
                <p class="text-muted mb-0">
                    <small>© @DateTime.Now.Year BusOps - Sistema de Gestión de Flota de Autobuses</small>
                </p>
                <p class="text-muted mb-0 mt-1">
                    <small><i class="bi bi-code-square"></i> Versión Beta 20260223</small>
                </p>
            </div>
        </footer>
    }
</div>

@code {
    private ConfiguracionEmpresa? configuracionEmpresa;

    protected override async Task OnInitializedAsync()
    {
        await CargarConfiguracion();
    }

    private async Task CargarConfiguracion()
    {
        try
        {
            using var context = await DbFactory.CreateDbContextAsync();
            configuracionEmpresa = await context.ConfiguracionEmpresa.FirstOrDefaultAsync();
        }
        catch (Exception ex)
        {
            // En caso de error, simplemente no mostrar los datos de la empresa
            Console.WriteLine($"Error al cargar configuración: {ex.Message}");
        }
    }
}
