@page "/configuracion"
@using BusOps.Models
@using BusOps.Data
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject IDbContextFactory<BusOpsDbContext> DbFactory
@inject IWebHostEnvironment Environment
@inject ProtectedSessionStorage SessionStorage
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>BusOps - Configuraci√≥n</PageTitle>

<div class="container-fluid mt-4">
    <h3><i class="bi bi-gear-fill"></i> Configuraci√≥n</h3>

    <!-- Tabs de navegaci√≥n -->
    <ul class="nav nav-tabs mt-4" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(tabActivo == "empresa" ? "active" : "")" 
                    @onclick='() => tabActivo = "empresa"' 
                    type="button">
                <i class="bi bi-building"></i> Configuraci√≥n de Empresa
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(tabActivo == "documentos" ? "active" : "")" 
                    @onclick='() => tabActivo = "documentos"' 
                    type="button">
                <i class="bi bi-file-earmark-text"></i> Documentos
            </button>
        </li>
        @if (IsSuperAdmin)
        {
            <li class="nav-item" role="presentation">
                <button class="nav-link @(tabActivo == "usuarios" ? "active" : "")" 
                        @onclick='() => tabActivo = "usuarios"' 
                        type="button">
                    <i class="bi bi-people-fill"></i> Gesti√≥n de Usuarios
                </button>
            </li>
        }
    </ul>

    <!-- Contenido de tabs -->
    <div class="tab-content mt-3">
        @if (tabActivo == "empresa")
        {
            <div class="row justify-content-center">
                <div class="col-md-10 col-lg-8">
        <!-- Datos de la empresa -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-building"></i> Datos de la Empresa</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nombre de la Empresa *</label>
                        <input type="text" class="form-control" @bind="configuracion.NombreEmpresa" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">NIF/CIF *</label>
                        <input type="text" class="form-control" @bind="configuracion.NIF" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Direcci√≥n *</label>
                        <input type="text" class="form-control" @bind="configuracion.Direccion" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Ciudad *</label>
                        <input type="text" class="form-control" @bind="configuracion.Ciudad" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">C√≥digo Postal *</label>
                        <input type="text" class="form-control" @bind="configuracion.CodigoPostal" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Provincia *</label>
                        <input type="text" class="form-control" @bind="configuracion.Provincia" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tel√©fono *</label>
                        <input type="text" class="form-control" @bind="configuracion.Telefono" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" @bind="configuracion.Email" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Sitio Web</label>
                        <input type="text" class="form-control" @bind="configuracion.Web" placeholder="https://www.ejemplo.com" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">IBAN (para facturas)</label>
                        <input type="text" class="form-control" @bind="configuracion.IBAN" placeholder="ES00 0000 0000 0000 0000 0000" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Logo de la Empresa</label>
                        @if (!string.IsNullOrEmpty(logoPreview))
                        {
                            <div class="mb-3 text-center p-3" style="background-color: #f8f9fa; border-radius: 8px;">
                                <img src="@logoPreview" alt="Logo Empresa" style="max-height: 150px; max-width: 100%; border-radius: 8px; border: 2px solid #dee2e6;" />
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-danger" @onclick="EliminarLogo">
                                        <i class="bi bi-trash"></i> Eliminar Logo
                                    </button>
                                </div>
                            </div>
                        }
                        <div>
                            <InputFile OnChange="CargarLogo" class="form-control" accept="image/*" />
                            <small class="text-muted">Formatos soportados: JPG, PNG, GIF. Tama√±o m√°ximo: 2MB</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Datos FacturaE -->
        <div class="card mb-4">
            <div class="card-header" style="background-color: #9C27B0; color: white;">
                <h5><i class="bi bi-file-earmark-text"></i> Datos para FacturaE (Facturaci√≥n Electr√≥nica)</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Tipo de Persona</label>
                        <select class="form-select" @bind="configuracion.TipoPersona">
                            <option value="@TipoPersona.Fisica">F√≠sica</option>
                            <option value="@TipoPersona.Juridica">Jur√≠dica</option>
                        </select>
                        <small class="text-muted">Normalmente "Jur√≠dica" para empresas</small>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Tipo de Residencia</label>
                        <select class="form-select" @bind="configuracion.TipoResidencia">
                            <option value="@TipoResidencia.Residente">Residente</option>
                            <option value="@TipoResidencia.UnionEuropea">Uni√≥n Europea</option>
                            <option value="@TipoResidencia.Extranjero">Extranjero</option>
                        </select>
                        <small class="text-muted">Normalmente "Residente" para empresas espa√±olas</small>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Nombre Comercial</label>
                        <input type="text" class="form-control" @bind="configuracion.NombreComercial" placeholder="Nombre comercial (opcional)" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Persona de Contacto</label>
                        <input type="text" class="form-control" @bind="configuracion.PersonaContacto" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">C√≥digo INE</label>
                        <input type="text" class="form-control" @bind="configuracion.CodigoINE" placeholder="Para administraciones p√∫blicas" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">CNAE</label>
                        <input type="text" class="form-control" @bind="configuracion.CNAE" placeholder="C√≥digo actividad econ√≥mica" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Libro Registro</label>
                        <input type="text" class="form-control" @bind="configuracion.LibroRegistro" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Registro Mercantil</label>
                        <input type="text" class="form-control" @bind="configuracion.RegistroMercantil" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Hoja</label>
                        <input type="text" class="form-control" @bind="configuracion.HojaRegistro" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Folio</label>
                        <input type="text" class="form-control" @bind="configuracion.FolioRegistro" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Secci√≥n</label>
                        <input type="text" class="form-control" @bind="configuracion.SeccionRegistro" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Tomo</label>
                        <input type="text" class="form-control" @bind="configuracion.TomoRegistro" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Datos Adicionales</label>
                        <input type="text" class="form-control" @bind="configuracion.DatosRegistroAdicionales" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuraci√≥n de facturaci√≥n -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-receipt"></i> Configuraci√≥n de Facturaci√≥n</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-info-circle"></i> La serie de factura define el formato de numeraci√≥n de tus facturas.
                    </div>
                    <div>
                        <strong>Pr√≥xima factura:</strong> <code class="fs-5">@GenerarEjemploFactura()</code>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Serie de Factura *</label>
                        <input type="text" class="form-control" @bind="configuracion.SerieFactura" @bind:event="oninput" maxlength="10" />
                        <small class="text-muted">Ej: AYE, FAC, FV</small>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Subserie</label>
                        <input type="text" class="form-control" @bind="configuracion.SubserieFactura" @bind:event="oninput" maxlength="5" />
                        <small class="text-muted">Letra adicional (ej: A, B)</small>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">N√∫mero Actual</label>
                        <input type="number" class="form-control" @bind="configuracion.NumeroFacturaActual" @bind:event="oninput" />
                        <small class="text-muted">Pr√≥xima factura usar√° este n√∫mero</small>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Longitud del N√∫mero</label>
                        <input type="number" class="form-control" @bind="configuracion.LongitudNumeroFactura" @bind:event="oninput" min="2" max="8" />
                        <small class="text-muted">D√≠gitos (ej: 2 = 01)</small>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="configuracion.IncluirA√±oEnSerie" id="incluirA√±o">
                            <label class="form-check-label" for="incluirA√±o">
                                Incluir a√±o en la serie
                            </label>
                        </div>
                        <small class="text-muted">Genera formato con a√±o</small>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="configuracion.IncluirMesEnSerie" @bind:event="oninput" id="incluirMes">
                            <label class="form-check-label" for="incluirMes">
                                Incluir mes en la serie
                            </label>
                        </div>
                        <small class="text-muted">A√±ade n√∫mero de mes (01-12)</small>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">IVA por Defecto (%)</label>
                        <input type="number" step="0.01" class="form-control" @bind="configuracion.IVAPorDefecto" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">D√≠as de Vencimiento</label>
                        <input type="number" class="form-control" @bind="configuracion.DiasVencimientoPorDefecto" />
                        <small class="text-muted">D√≠as para pagar la factura</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuraci√≥n de presupuestos -->
        <div class="card mb-4">
            <div class="card-header" style="background-color: #4CAF50; color: white;">
                <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Configuraci√≥n de Presupuestos</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-info-circle"></i> La serie de presupuesto define el formato de numeraci√≥n de tus presupuestos.
                    </div>
                    <div>
                        <strong>Pr√≥ximo presupuesto:</strong> <code class="fs-5">@GenerarEjemploPresupuesto()</code>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Serie de Presupuesto *</label>
                        <input type="text" class="form-control" @bind="configuracion.SeriePresupuesto" @bind:event="oninput" maxlength="10" />
                        <small class="text-muted">Ej: PRES, PRE, PRESUP</small>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">N√∫mero Actual</label>
                        <input type="number" class="form-control" @bind="configuracion.NumeroPresupuestoActual" @bind:event="oninput" />
                        <small class="text-muted">Pr√≥ximo presupuesto usar√° este n√∫mero</small>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Longitud del N√∫mero</label>
                        <input type="number" class="form-control" @bind="configuracion.LongitudNumeroPresupuesto" @bind:event="oninput" min="3" max="8" />
                        <small class="text-muted">D√≠gitos del n√∫mero (ej: 4 = 0001)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Datos Financieros -->
        <div class="card shadow-sm mb-4">
            <div class="card-header" style="background-color: #FF9800; color: white;">
                <h5 class="mb-0"><i class="bi bi-credit-card"></i> Datos Financieros y Contacto</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Cuenta Bancaria</label>
                        <input type="text" class="form-control" @bind="configuracion.CuentaBancaria" placeholder="N√∫mero de cuenta" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Forma de Pago</label>
                        <input type="text" class="form-control" @bind="configuracion.FormaPago" placeholder="Ej: Transferencia, Efectivo" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">L√≠mite de Cr√©dito</label>
                        <input type="number" step="0.01" class="form-control" @bind="configuracion.LimiteCredito" placeholder="0.00" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">D√≠as de Pago</label>
                        <input type="number" class="form-control" @bind="configuracion.DiasPago" placeholder="30" />
                        <small class="text-muted">D√≠as para realizar pagos a proveedores</small>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Contacto</label>
                        <input type="text" class="form-control" @bind="configuracion.Contacto" placeholder="Nombre del contacto principal" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Certificado Digital para Firma Electr√≥nica -->
        <div class="card shadow-sm mb-4">
            <div class="card-header" style="background-color: #9C27B0; color: white;">
                <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Certificado Digital para Firma Electr√≥nica</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Sube tu certificado digital (.pfx o .p12) para firmar autom√°ticamente los archivos XML de FacturaE.
                    La firma digital es obligatoria para enviar facturas a la administraci√≥n p√∫blica.
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Archivo de Certificado (.pfx / .p12)</label>
                        <InputFile class="form-control" OnChange="CargarCertificado" accept=".pfx,.p12" />
                        @if (!string.IsNullOrEmpty(configuracion.CertificadoRuta))
                        {
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-success">
                                    <i class="bi bi-check-circle"></i> Certificado cargado: @Path.GetFileName(configuracion.CertificadoRuta)
                                </small>
                                <button type="button" class="btn btn-sm btn-danger" @onclick="EliminarCertificado">
                                    <i class="bi bi-trash"></i> Eliminar
                                </button>
                            </div>
                        }
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Contrase√±a del Certificado</label>
                        <input type="password" class="form-control" @bind="configuracion.CertificadoPassword" placeholder="Contrase√±a del certificado" />
                        <small class="text-muted">Se guardar√° de forma segura</small>
                    </div>
                </div>
                
                @if (!string.IsNullOrEmpty(certificadoInfo))
                {
                    <div class="alert alert-success">
                        <strong><i class="bi bi-info-circle"></i> Informaci√≥n del Certificado:</strong>
                        <pre class="mb-0 mt-2">@certificadoInfo</pre>
                    </div>
                }
            </div>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-lg" style="background-color: #003366; color: white;" @onclick="GuardarConfiguracion">
                <i class="bi bi-save"></i> Guardar Configuraci√≥n
            </button>
            <button class="btn btn-secondary btn-lg" @onclick="CancelarEdicion">
                <i class="bi bi-x-circle"></i> Cancelar
            </button>
        </div>
                </div>
            </div>
        }
        else if (tabActivo == "documentos")
        {
            <div class="card shadow-sm">
                <div class="card-header" style="background-color: #FF9800; color: white;">
                    <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Documentos de la Empresa</h5>
                </div>
                <div class="card-body">
                    @if (configuracion.Id == 0)
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Primero guarda la configuraci√≥n para poder gestionar documentos.
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#documentoModal" @onclick="NuevoDocumento">
                                <i class="bi bi-plus-circle"></i> Agregar Documento
                            </button>
                        </div>
                        
                        @if (documentos.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Nombre</th>
                                            <th>Descripci√≥n</th>
                                            <th>Fecha Subida</th>
                                            <th>Vencimiento</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var doc in documentos)
                                        {
                                            <tr>
                                                <td><span class="badge bg-secondary">@doc.TipoDocumento</span></td>
                                                <td>@doc.NombreArchivo</td>
                                                <td>@doc.Descripcion</td>
                                                <td>@doc.FechaSubida.ToString("dd/MM/yyyy")</td>
                                                <td>@(doc.FechaVencimiento?.ToString("dd/MM/yyyy") ?? "-")</td>
                                                <td>
                                                    <a href="@doc.RutaArchivo" target="_blank" class="btn btn-sm btn-outline-primary" title="Ver">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => EliminarDocumento(doc.Id)" title="Eliminar">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-center text-muted py-4">No hay documentos registrados para la empresa</p>
                        }
                    }
                </div>
            </div>
        }
        else if (tabActivo == "usuarios")
        {
            <BusOps.Components.Pages.Usuarios />
        }
    </div>
</div>

<!-- Modal para agregar documento -->
<div class="modal fade" id="documentoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header text-white" style="background-color: #8E24AA;">
                <h5 class="modal-title">Agregar Documento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Tipo de Documento *</label>
                    <select class="form-select" @bind="nuevoDoc.TipoDocumento">
                        <option value="Licencia">Licencia de Transporte</option>
                        <option value="Seguro">Seguro de Empresa</option>
                        <option value="Certificado">Certificado</option>
                        <option value="Contrato">Contrato</option>
                        <option value="Legal">Documento Legal</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Nombre del Archivo *</label>
                    <input type="text" class="form-control" @bind="nuevoDoc.NombreArchivo" placeholder="Ej: Licencia_Transporte_2025.pdf" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea class="form-control" rows="2" @bind="nuevoDoc.Descripcion" placeholder="Descripci√≥n opcional del documento"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Archivo *</label>
                    <InputFile OnChange="HandleFileSelected" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" />
                    <small class="text-muted">Selecciona un archivo PDF, Word o imagen</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Fecha de Vencimiento (opcional)</label>
                    <input type="date" class="form-control" @bind="fechaVencimientoDoc" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn" style="background-color: #003366; color: white;" @onclick="GuardarDocumento">
                    <i class="bi bi-save me-1"></i>Guardar
                </button>
            </div>
        </div>
    </div>
</div>

@if (mostrarMensaje)
{
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div class="toast show" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="bi bi-check-circle me-2"></i>
                <strong class="me-auto">√âxito</strong>
                <button type="button" class="btn-close btn-close-white" @onclick="() => mostrarMensaje = false"></button>
            </div>
            <div class="toast-body">
                Configuraci√≥n guardada correctamente
            </div>
        </div>
    </div>
}

@code {
    private ConfiguracionEmpresa configuracion = new();
    private bool mostrarMensaje = false;
    private string logoPreview = string.Empty;
    private string certificadoInfo = string.Empty;
    private string tabActivo = "empresa";
    private string? currentUserRole;
    private bool hasChecked = false;
    private List<Documento> documentos = new();
    private Documento nuevoDoc = new();
    private DateTime? fechaVencimientoDoc;
    private IBrowserFile? archivoSeleccionado;
    private int? CurrentEmpresaId;
    private bool IsSuperAdmin = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasChecked)
        {
            hasChecked = true;
            
            // Verificar si el usuario es administrador o superadministrador
            var roleResult = await SessionStorage.GetAsync<string>("userRole");
            if (!roleResult.Success || !(roleResult.Value == "Administrador" || roleResult.Value == "SuperAdministrador"))
            {
                NavigationManager.NavigateTo("/");
                return;
            }
            
            currentUserRole = roleResult.Value;
            IsSuperAdmin = roleResult.Value == "SuperAdministrador";
            
            // Cargar EmpresaId para multi-tenancy (SuperAdmin no tiene EmpresaId)
            var empresaResult = await SessionStorage.GetAsync<int>("EmpresaId");
            if (empresaResult.Success)
            {
                CurrentEmpresaId = empresaResult.Value;
            }
            
            Console.WriteLine($"üîß CONFIGURACION - EmpresaId: {CurrentEmpresaId}, IsSuperAdmin: {IsSuperAdmin}");
            
            await CargarConfiguracion();
            StateHasChanged();
        }
    }

    private async Task CargarConfiguracion()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        context.IsSuperAdmin = IsSuperAdmin;
        context.CurrentEmpresaId = CurrentEmpresaId;
        
        Console.WriteLine($"=== CARGAR CONFIGURACI√ìN ===");
        Console.WriteLine($"IsSuperAdmin: {IsSuperAdmin}, CurrentEmpresaId: {CurrentEmpresaId}");
        
        // Cargar desde la base de datos
        configuracion = await context.ConfiguracionEmpresa
            .Include(c => c.Documentos)
            .FirstOrDefaultAsync() ?? new ConfiguracionEmpresa
        {
            NombreEmpresa = "BusOps Transportes S.L.",
            NIF = "B12345678",
            Direccion = "Calle Principal 123",
            Ciudad = "Madrid",
            CodigoPostal = "28001",
            Provincia = "Madrid",
            Telefono = "910123456",
            Email = "info@busops.com",
            Web = "https://www.busops.com",
            IBAN = "ES00 0000 0000 0000 0000 0000",
            SerieFactura = "FAC",
            NumeroFacturaActual = 1,
            LongitudNumeroFactura = 4,
            IncluirA√±oEnSerie = true,
            IVAPorDefecto = 21m,
            DiasVencimientoPorDefecto = 30
        };

        Console.WriteLine($"Configuraci√≥n cargada - Id: {configuracion.Id}");
        Console.WriteLine($"NIF: {configuracion.NIF}, Nombre: {configuracion.NombreEmpresa}");
        Console.WriteLine($"TipoPersona: {configuracion.TipoPersona}, CodigoINE: {configuracion.CodigoINE}");

        // Cargar preview del logo si existe
        if (!string.IsNullOrEmpty(configuracion.LogoRuta))
        {
            logoPreview = configuracion.LogoRuta;
        }

        // Cargar informaci√≥n del certificado si existe
        if (!string.IsNullOrEmpty(configuracion.CertificadoRuta) && 
            !string.IsNullOrEmpty(configuracion.CertificadoPassword))
        {
            try
            {
                if (File.Exists(configuracion.CertificadoRuta))
                {
                    var cert = new System.Security.Cryptography.X509Certificates.X509Certificate2(
                        configuracion.CertificadoRuta, 
                        configuracion.CertificadoPassword
                    );
                    
                    var ahora = DateTime.Now;
                    var estaVigente = ahora >= cert.NotBefore && ahora <= cert.NotAfter;
                    var diasRestantes = (cert.NotAfter - ahora).Days;
                    
                    certificadoInfo = $"Titular: {cert.Subject}\n" +
                                    $"Emisor: {cert.Issuer}\n" +
                                    $"V√°lido desde: {cert.NotBefore:dd/MM/yyyy}\n" +
                                    $"V√°lido hasta: {cert.NotAfter:dd/MM/yyyy}\n" +
                                    $"Estado: {(estaVigente ? "‚úÖ VIGENTE" : "‚ùå EXPIRADO")}\n" +
                                    $"D√≠as restantes: {(estaVigente ? diasRestantes.ToString() : "N/A")}";
                    
                    Console.WriteLine($"Certificado cargado: {cert.Subject}");
                }
                else
                {
                    certificadoInfo = "‚ö†Ô∏è Archivo de certificado no encontrado. Vuelve a cargarlo.";
                    Console.WriteLine($"Certificado no encontrado en: {configuracion.CertificadoRuta}");
                }
            }
            catch (Exception ex)
            {
                certificadoInfo = $"‚ùå Error al cargar certificado: {ex.Message}";
                Console.WriteLine($"Error al cargar certificado: {ex.Message}");
            }
        }

        // Cargar documentos si existe configuraci√≥n
        if (configuracion.Id > 0)
        {
            documentos = configuracion.Documentos.ToList();
        }
    }

    private async Task CargarLogo(Microsoft.AspNetCore.Components.Forms.InputFileChangeEventArgs e)
    {
        var archivo = e.File;
        
        if (archivo != null)
        {
            // Validar tama√±o (m√°ximo 2MB)
            if (archivo.Size > 2 * 1024 * 1024)
            {
                return; // En una app real, mostrar error
            }

            // Validar tipo de archivo
            if (!archivo.ContentType.StartsWith("image/"))
            {
                return; // En una app real, mostrar error
            }

            // Crear directorio de logos si no existe
            var logosPath = Path.Combine(Environment.WebRootPath, "logos");
            if (!Directory.Exists(logosPath))
            {
                Directory.CreateDirectory(logosPath);
            }

            // Generar nombre √∫nico para el archivo
            var extension = Path.GetExtension(archivo.Name);
            var nombreArchivo = $"logo-empresa{extension}";
            var rutaCompleta = Path.Combine(logosPath, nombreArchivo);

            // Guardar archivo f√≠sicamente
            using (var stream = archivo.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024))
            {
                using (var fileStream = new FileStream(rutaCompleta, FileMode.Create))
                {
                    await stream.CopyToAsync(fileStream);
                }
            }

            // Actualizar ruta en la configuraci√≥n
            configuracion.LogoRuta = $"/logos/{nombreArchivo}";
            logoPreview = configuracion.LogoRuta;
        }
    }

    private async Task EliminarCertificado()
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "¬øEst√°s seguro de que deseas eliminar el certificado digital? Esta acci√≥n no se puede deshacer."))
        {
            return;
        }

        try
        {
            // Eliminar archivo f√≠sico si existe
            if (!string.IsNullOrEmpty(configuracion.CertificadoRuta) && File.Exists(configuracion.CertificadoRuta))
            {
                File.Delete(configuracion.CertificadoRuta);
                Console.WriteLine($"‚úÖ Certificado f√≠sico eliminado: {configuracion.CertificadoRuta}");
            }

            // Limpiar campos en la configuraci√≥n
            configuracion.CertificadoRuta = null;
            configuracion.CertificadoPassword = null;
            certificadoInfo = string.Empty;

            // Guardar cambios en la base de datos
            using var context = await DbFactory.CreateDbContextAsync();
            context.IsSuperAdmin = IsSuperAdmin;
            context.CurrentEmpresaId = CurrentEmpresaId;

            var configExistente = await context.ConfiguracionEmpresa.FindAsync(configuracion.Id);
            if (configExistente != null)
            {
                configExistente.CertificadoRuta = null;
                configExistente.CertificadoPassword = null;
                await context.SaveChangesAsync();
                Console.WriteLine("‚úÖ Certificado eliminado de la base de datos");
            }

            await JSRuntime.InvokeVoidAsync("alert", "Certificado eliminado exitosamente");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error al eliminar certificado: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error al eliminar el certificado: {ex.Message}");
        }
    }

    private async Task CargarCertificado(Microsoft.AspNetCore.Components.Forms.InputFileChangeEventArgs e)
    {
        var archivo = e.File;
        
        if (archivo != null)
        {
            // Validar tama√±o (m√°ximo 5MB)
            if (archivo.Size > 5 * 1024 * 1024)
            {
                await JSRuntime.InvokeVoidAsync("alert", "El archivo de certificado no puede superar 5MB");
                return;
            }

            // Validar extensi√≥n
            var extension = Path.GetExtension(archivo.Name).ToLower();
            if (extension != ".pfx" && extension != ".p12")
            {
                await JSRuntime.InvokeVoidAsync("alert", "Solo se aceptan archivos .pfx o .p12");
                return;
            }

            // Crear directorio de certificados si no existe
            var certificadosPath = Path.Combine(Environment.WebRootPath, "certificados");
            if (!Directory.Exists(certificadosPath))
            {
                Directory.CreateDirectory(certificadosPath);
            }

            // Generar nombre √∫nico para el archivo
            var nombreArchivo = $"certificado-empresa{extension}";
            var rutaCompleta = Path.Combine(certificadosPath, nombreArchivo);

            // Guardar archivo f√≠sicamente
            using (var stream = archivo.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024))
            {
                using (var fileStream = new FileStream(rutaCompleta, FileMode.Create))
                {
                    await stream.CopyToAsync(fileStream);
                }
            }

            // Actualizar ruta en la configuraci√≥n
            configuracion.CertificadoRuta = rutaCompleta;
            
            // Intentar cargar informaci√≥n del certificado (si se ha proporcionado contrase√±a)
            if (!string.IsNullOrEmpty(configuracion.CertificadoPassword))
            {
                try
                {
                    var cert = new System.Security.Cryptography.X509Certificates.X509Certificate2(
                        rutaCompleta, 
                        configuracion.CertificadoPassword
                    );
                    
                    var ahora = DateTime.Now;
                    var estaVigente = ahora >= cert.NotBefore && ahora <= cert.NotAfter;
                    var diasRestantes = (cert.NotAfter - ahora).Days;
                    
                    certificadoInfo = $"Titular: {cert.Subject}\n" +
                                    $"Emisor: {cert.Issuer}\n" +
                                    $"V√°lido desde: {cert.NotBefore:dd/MM/yyyy}\n" +
                                    $"V√°lido hasta: {cert.NotAfter:dd/MM/yyyy}\n" +
                                    $"Estado: {(estaVigente ? "‚úÖ VIGENTE" : "‚ùå EXPIRADO")}\n" +
                                    $"D√≠as restantes: {(estaVigente ? diasRestantes.ToString() : "N/A")}";
                    
                    if (!estaVigente)
                    {
                        await JSRuntime.InvokeVoidAsync("alert", 
                            $"‚ö†Ô∏è ADVERTENCIA: El certificado ha expirado el {cert.NotAfter:dd/MM/yyyy}");
                    }
                    else if (diasRestantes < 30)
                    {
                        await JSRuntime.InvokeVoidAsync("alert", 
                            $"‚ö†Ô∏è ADVERTENCIA: El certificado expirar√° en {diasRestantes} d√≠as ({cert.NotAfter:dd/MM/yyyy})");
                    }
                    
                    StateHasChanged();
                }
                catch (Exception ex)
                {
                    certificadoInfo = $"‚ùå No se pudo leer el certificado. Verifica la contrase√±a.\nError: {ex.Message}";
                    await JSRuntime.InvokeVoidAsync("alert", $"Error al leer el certificado: {ex.Message}");
                }
            }
            else
            {
                certificadoInfo = "üìã Certificado cargado. Introduce la contrase√±a y guarda para ver la informaci√≥n completa.";
            }
        }
    }

    private string GenerarEjemploFactura()
    {
        var numero = configuracion.NumeroFacturaActual.ToString().PadLeft(configuracion.LongitudNumeroFactura, '0');
        if (configuracion.IncluirA√±oEnSerie)
        {
            // Formato: SERIE + A√ëO + SUBSERIE + [MES] + NUMERO (ej: AYE2026A02-0001 o AYE2026A0001)
            var subserie = string.IsNullOrWhiteSpace(configuracion.SubserieFactura) ? "" : configuracion.SubserieFactura;
            var mes = configuracion.IncluirMesEnSerie ? DateTime.Now.Month.ToString("D2") : "";
            var separador = configuracion.IncluirMesEnSerie ? "-" : "";
            return $"{configuracion.SerieFactura}{DateTime.Now.Year}{subserie}{mes}{separador}{numero}";
        }
        return $"{configuracion.SerieFactura}-{numero}";
    }

    private string GenerarEjemploPresupuesto()
    {
        var numero = configuracion.NumeroPresupuestoActual.ToString().PadLeft(configuracion.LongitudNumeroPresupuesto, '0');
        if (configuracion.IncluirA√±oEnSerie)
        {
            return $"{configuracion.SeriePresupuesto}-{DateTime.Now.Year}-{numero}";
        }
        return $"{configuracion.SeriePresupuesto}-{numero}";
    }

    private async Task GuardarConfiguracion()
    {
        try
        {
            using var context = await DbFactory.CreateDbContextAsync();
            context.IsSuperAdmin = IsSuperAdmin;
            context.CurrentEmpresaId = CurrentEmpresaId;
            
            Console.WriteLine($"=== GUARDAR CONFIGURACI√ìN ===");
            Console.WriteLine($"IsSuperAdmin: {IsSuperAdmin}, CurrentEmpresaId: {CurrentEmpresaId}");
            Console.WriteLine($"Datos a guardar - NIF: {configuracion.NIF}, Nombre: {configuracion.NombreEmpresa}");
            Console.WriteLine($"TipoPersona: {configuracion.TipoPersona}, CodigoINE: {configuracion.CodigoINE}");
            
            // Verificar si ya existe una configuraci√≥n
            var existente = await context.ConfiguracionEmpresa.FirstOrDefaultAsync();
            
            Console.WriteLine($"Registro existente encontrado: {existente != null}, Id: {existente?.Id ?? 0}");
            
            if (existente != null)
            {
                Console.WriteLine($"Valores ANTES de actualizar - NIF: {existente.NIF}, CodigoINE: {existente.CodigoINE}");
                
                // Actualizar configuraci√≥n existente
                existente.NombreEmpresa = configuracion.NombreEmpresa;
                existente.NIF = configuracion.NIF;
                existente.Direccion = configuracion.Direccion;
                existente.Ciudad = configuracion.Ciudad;
                existente.CodigoPostal = configuracion.CodigoPostal;
                existente.Provincia = configuracion.Provincia;
                existente.Pais = configuracion.Pais;
                existente.Telefono = configuracion.Telefono;
                existente.Fax = configuracion.Fax;
                existente.Email = configuracion.Email;
                existente.Web = configuracion.Web;
                existente.IBAN = configuracion.IBAN;
                
                // Datos FacturaE
                existente.TipoPersona = configuracion.TipoPersona;
                existente.TipoResidencia = configuracion.TipoResidencia;
                existente.NombreComercial = configuracion.NombreComercial;
                existente.PersonaContacto = configuracion.PersonaContacto;
                existente.CodigoINE = configuracion.CodigoINE;
                existente.CNAE = configuracion.CNAE;
                existente.LibroRegistro = configuracion.LibroRegistro;
                existente.RegistroMercantil = configuracion.RegistroMercantil;
                existente.HojaRegistro = configuracion.HojaRegistro;
                existente.FolioRegistro = configuracion.FolioRegistro;
                existente.SeccionRegistro = configuracion.SeccionRegistro;
                existente.TomoRegistro = configuracion.TomoRegistro;
                existente.DatosRegistroAdicionales = configuracion.DatosRegistroAdicionales;
                
                // Configuraci√≥n de facturaci√≥n
                existente.SerieFactura = configuracion.SerieFactura;
                existente.NumeroFacturaActual = configuracion.NumeroFacturaActual;
                existente.LongitudNumeroFactura = configuracion.LongitudNumeroFactura;
                existente.IncluirA√±oEnSerie = configuracion.IncluirA√±oEnSerie;
                existente.SeriePresupuesto = configuracion.SeriePresupuesto;
                existente.NumeroPresupuestoActual = configuracion.NumeroPresupuestoActual;
                existente.LongitudNumeroPresupuesto = configuracion.LongitudNumeroPresupuesto;
                existente.IVAPorDefecto = configuracion.IVAPorDefecto;
                existente.DiasVencimientoPorDefecto = configuracion.DiasVencimientoPorDefecto;
                
                // Datos financieros
                existente.LogoRuta = configuracion.LogoRuta;
                existente.CuentaBancaria = configuracion.CuentaBancaria;
                existente.FormaPago = configuracion.FormaPago;
                existente.LimiteCredito = configuracion.LimiteCredito;
                existente.DiasPago = configuracion.DiasPago;
                existente.Contacto = configuracion.Contacto;
                
                // Certificado digital
                existente.CertificadoRuta = configuracion.CertificadoRuta;
                existente.CertificadoPassword = configuracion.CertificadoPassword;
                
                existente.EmpresaId = CurrentEmpresaId; // Asignar EmpresaId
                
                Console.WriteLine($"Valores DESPU√âS de asignar - NIF: {existente.NIF}, CodigoINE: {existente.CodigoINE}");
                
                context.ConfiguracionEmpresa.Update(existente);
            }
            else
            {
                // Crear nueva configuraci√≥n
                Console.WriteLine("Creando nueva configuraci√≥n");
                if (CurrentEmpresaId.HasValue)
                {
                    configuracion.EmpresaId = CurrentEmpresaId;
                }
                context.ConfiguracionEmpresa.Add(configuracion);
            }
            
            var cambios = await context.SaveChangesAsync();
            Console.WriteLine($"‚úÖ Configuraci√≥n guardada. Registros afectados: {cambios}");
            
            // Recargar desde BD para verificar
            var verificacion = await context.ConfiguracionEmpresa.FirstOrDefaultAsync();
            Console.WriteLine($"Verificaci√≥n - NIF guardado: {verificacion?.NIF}, CodigoINE: {verificacion?.CodigoINE}");
            
            mostrarMensaje = true;
            StateHasChanged();
            
            // Ocultar mensaje despu√©s de 3 segundos
            await Task.Delay(3000);
            mostrarMensaje = false;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            // En producci√≥n, manejar el error apropiadamente
            Console.WriteLine($"Error al guardar configuraci√≥n: {ex.Message}");
        }
    }

    private async Task CancelarEdicion()
    {
        await CargarConfiguracion();
    }

    private void EliminarLogo()
    {
        configuracion.LogoRuta = string.Empty;
        logoPreview = string.Empty;
    }

    private void NuevoDocumento()
    {
        nuevoDoc = new Documento
        {
            TipoDocumento = "Licencia",
            FechaSubida = DateTime.Now,
            ConfiguracionEmpresaId = configuracion.Id
        };
        fechaVencimientoDoc = null;
        archivoSeleccionado = null;
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        archivoSeleccionado = e.File;
        nuevoDoc.NombreArchivo = archivoSeleccionado.Name;
    }

    private async Task GuardarDocumento()
    {
        if (archivoSeleccionado == null)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Debes seleccionar un archivo");
            return;
        }

        var rutaDocumentos = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "documentos", "empresa");
        Directory.CreateDirectory(rutaDocumentos);

        var nombreArchivo = $"{configuracion.Id}_{DateTime.Now:yyyyMMddHHmmss}_{archivoSeleccionado.Name}";
        var rutaCompleta = Path.Combine(rutaDocumentos, nombreArchivo);

        using (var stream = new FileStream(rutaCompleta, FileMode.Create))
        {
            await archivoSeleccionado.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(stream);
        }

        nuevoDoc.RutaArchivo = $"/documentos/empresa/{nombreArchivo}";
        nuevoDoc.FechaVencimiento = fechaVencimientoDoc;
        nuevoDoc.ConfiguracionEmpresaId = configuracion.Id;
        
        using var context = await DbFactory.CreateDbContextAsync();
        context.IsSuperAdmin = IsSuperAdmin;
        context.CurrentEmpresaId = CurrentEmpresaId;
        context.Documentos.Add(nuevoDoc);
        await context.SaveChangesAsync();
        
        documentos = await context.Documentos
            .Where(d => d.ConfiguracionEmpresaId == configuracion.Id)
            .ToListAsync();
        
        await JSRuntime.InvokeVoidAsync("eval", "bootstrap.Modal.getInstance(document.getElementById('documentoModal')).hide()");
        StateHasChanged();
    }

    private async Task EliminarDocumento(int documentoId)
    {
        var confirmar = await JSRuntime.InvokeAsync<bool>("confirm", "¬øEst√°s seguro de que deseas eliminar este documento?");
        if (!confirmar) return;

        using var context = await DbFactory.CreateDbContextAsync();
        context.IsSuperAdmin = IsSuperAdmin;
        context.CurrentEmpresaId = CurrentEmpresaId;
        var documento = await context.Documentos.FindAsync(documentoId);
        if (documento != null)
        {
            context.Documentos.Remove(documento);
            await context.SaveChangesAsync();
            
            documentos = await context.Documentos
                .Where(d => d.ConfiguracionEmpresaId == configuracion.Id)
                .ToListAsync();
            
            StateHasChanged();
        }
    }
}
