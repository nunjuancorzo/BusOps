@page "/clientes/nuevo"
@page "/clientes/{Id:int}"
@using BusOps.Models
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>@(Id == 0 ? "Nuevo Cliente" : "Editar Cliente") - BusOps</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>@(Id == 0 ? "Nuevo Cliente" : "Editar Cliente")</h1>
    <button class="btn btn-outline-secondary" @onclick="Volver">
        <i class="bi bi-arrow-left"></i> Volver
    </button>
</div>

<div class="card">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Tipo de Cliente *</label>
                <select class="form-select" @bind="cliente.Tipo">
                    <option value="@TipoCliente.Particular">Particular</option>
                    <option value="@TipoCliente.Empresa">Empresa</option>
                    <option value="@TipoCliente.Agencia">Agencia</option>
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">NIF/CIF *</label>
                <input type="text" class="form-control" @bind="cliente.NIF" />
            </div>
        </div>

        @if (cliente.Tipo == TipoCliente.Particular)
        {
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nombre *</label>
                    <input type="text" class="form-control" @bind="cliente.Nombre" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Apellidos</label>
                    <input type="text" class="form-control" @bind="cliente.Apellidos" />
                </div>
            </div>
        }
        else
        {
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nombre de la Empresa *</label>
                    <input type="text" class="form-control" @bind="cliente.NombreEmpresa" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Persona de Contacto</label>
                    <input type="text" class="form-control" @bind="cliente.Nombre" />
                </div>
            </div>
        }

        <div class="row">
            <div class="col-md-12 mb-3">
                <label class="form-label">Dirección</label>
                <input type="text" class="form-control" @bind="cliente.Direccion" />
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Ciudad</label>
                <input type="text" class="form-control" @bind="cliente.Ciudad" />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Código Postal</label>
                <input type="text" class="form-control" @bind="cliente.CodigoPostal" />
            </div>
        </div>

        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Provincia</label>
                <input type="text" class="form-control" @bind="cliente.Provincia" />
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">País</label>
                <input type="text" class="form-control" @bind="cliente.Pais" placeholder="ESP" />
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Fax</label>
                <input type="text" class="form-control" @bind="cliente.Fax" />
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Teléfono *</label>
                <input type="text" class="form-control" @bind="cliente.Telefono" />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Email *</label>
                <input type="email" class="form-control" @bind="cliente.Email" />
            </div>
        </div>

        <!-- Sección FacturaE -->
        <hr class="my-4" />
        <h5 class="mb-3"><i class="bi bi-file-earmark-text"></i> Datos para FacturaE</h5>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" @bind="cliente.ClienteFacturaE" id="clienteFacturaECheck">
                    <label class="form-check-label" for="clienteFacturaECheck">
                        <strong>Cliente FacturaE</strong>
                    </label>
                    <small class="text-muted d-block">Marque esta opción para clientes que requieren facturación electrónica con validaciones completas (administraciones públicas, etc.)</small>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Tipo de Persona</label>
                <select class="form-select" @bind="cliente.TipoPersona">
                    <option value="@TipoPersona.Fisica">Física</option>
                    <option value="@TipoPersona.Juridica">Jurídica</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Tipo de Residencia</label>
                <select class="form-select" @bind="cliente.TipoResidencia">
                    <option value="@TipoResidencia.Residente">Residente</option>
                    <option value="@TipoResidencia.UnionEuropea">Unión Europea</option>
                    <option value="@TipoResidencia.Extranjero">Extranjero</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Código INE</label>
                <input type="text" class="form-control" @bind="cliente.CodigoINE" placeholder="Para administraciones públicas" />
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 mb-3">
                <label class="form-label">Persona de Contacto (FacturaE)</label>
                <input type="text" class="form-control" @bind="cliente.PersonaContacto" />
            </div>
        </div>

        <!-- Datos Financieros -->
        <hr class="my-4" />
        <h5 class="mb-3"><i class="bi bi-credit-card"></i> Datos Financieros</h5>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Cuenta Bancaria / IBAN</label>
                <input type="text" class="form-control" @bind="cliente.CuentaBancaria" placeholder="ES00 0000 0000 00 0000000000" />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Forma de Pago</label>
                <input type="text" class="form-control" @bind="cliente.FormaPago" placeholder="Transferencia, Efectivo, etc." />
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Límite de Crédito (€)</label>
                <input type="number" step="0.01" class="form-control" @bind="cliente.LimiteCredito" />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Días de Pago</label>
                <input type="number" class="form-control" @bind="cliente.DiasPago" placeholder="30, 60, 90..." />
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 mb-3">
                <label class="form-label">Contacto Adicional</label>
                <input type="text" class="form-control" @bind="cliente.Contacto" />
            </div>
        </div>

        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" @bind="cliente.Activo" id="activoCheck">
            <label class="form-check-label" for="activoCheck">
                Cliente activo
            </label>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-primary" @onclick="Guardar">
                <i class="bi bi-save"></i> Guardar
            </button>
            <button class="btn btn-secondary" @onclick="Volver">
                Cancelar
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private Cliente cliente = new();

    protected override void OnInitialized()
    {
        if (Id > 0)
        {
            // Cargar cliente existente
            // TODO: Cargar desde base de datos
            cliente = new Cliente
            {
                Id = Id,
                Tipo = TipoCliente.Particular,
                Nombre = "Juan",
                Apellidos = "Pérez",
                NIF = "12345678A",
                Telefono = "600123456",
                Email = "juan@example.com",
                Activo = true
            };
        }
        else
        {
            cliente = new Cliente { FechaRegistro = DateTime.Now, Activo = true };
        }
    }

    private void Guardar()
    {
        // TODO: Guardar en base de datos
        NavigationManager.NavigateTo("/clientes");
    }

    private void Volver()
    {
        NavigationManager.NavigateTo("/clientes");
    }
}
