@page "/mantenimiento/nuevo"
@page "/mantenimiento/{Id:int}"
@using BusOps.Models
@using BusOps.Helpers
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>@(Id == 0 ? "Nuevo Mantenimiento" : "Editar Mantenimiento") - BusOps</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>@(Id == 0 ? "Nuevo Mantenimiento" : "Editar Mantenimiento")</h1>
    <button class="btn btn-outline-secondary" @onclick="Volver">
        <i class="bi bi-arrow-left"></i> Volver
    </button>
</div>

<div class="card">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Autobús *</label>
                <select class="form-select" @bind="mantenimiento.AutobusId">
                    <option value="0">-- Seleccione un autobús --</option>
                    @foreach (var autobus in autobuses)
                    {
                        <option value="@autobus.Id">@autobus.Matricula - @autobus.Marca @autobus.Modelo</option>
                    }
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Tipo de Mantenimiento *</label>
                <select class="form-select" @bind="mantenimiento.Tipo">
                    @foreach (var tipo in Enum.GetValues<TipoMantenimiento>())
                    {
                        <option value="@tipo">@tipo.GetDisplayName()</option>
                    }
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Fecha Inicio *</label>
                <input type="date" class="form-control" @bind="fechaInicio" />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Fecha Fin</label>
                <input type="date" class="form-control" @bind="fechaFin" />
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Taller</label>
                <input type="text" class="form-control" @bind="mantenimiento.Taller" placeholder="Nombre del taller" />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Costo (€)</label>
                <input type="number" step="0.01" class="form-control" @bind="mantenimiento.Costo" />
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Kilometraje</label>
                <input type="number" class="form-control" @bind="mantenimiento.KilometrajeMantenimiento" />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Estado *</label>
                <select class="form-select" @bind="mantenimiento.Estado">
                    @foreach (var estado in Enum.GetValues<EstadoMantenimiento>())
                    {
                        <option value="@estado">@estado.GetDisplayName()</option>
                    }
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 mb-3">
                <label class="form-label">Descripción</label>
                <textarea class="form-control" rows="3" @bind="mantenimiento.Descripcion" placeholder="Detalles del mantenimiento..."></textarea>
            </div>
        </div>
        <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary" @onclick="Guardar">
                <i class="bi bi-save"></i> Guardar
            </button>
            <button class="btn btn-secondary" @onclick="Volver">
                Cancelar
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private MantenimientoAutobus mantenimiento = new();
    private DateTime fechaInicio = DateTime.Now;
    private DateTime? fechaFin;
    private List<Autobus> autobuses = new();

    protected override void OnInitialized()
    {
        CargarDatos();
        
        if (Id > 0)
        {
            // TODO: Cargar desde base de datos
            mantenimiento = new MantenimientoAutobus
            {
                Id = Id,
                AutobusId = 1,
                Tipo = TipoMantenimiento.Preventivo,
                FechaInicio = DateTime.Now.AddDays(-2),
                FechaFin = DateTime.Now,
                Taller = "Taller Central",
                Costo = 350.00m,
                KilometrajeMantenimiento = 125000,
                Estado = EstadoMantenimiento.Completado,
                Descripcion = "Revisión general y cambio de aceite"
            };
            fechaInicio = mantenimiento.FechaInicio;
            fechaFin = mantenimiento.FechaFin;
        }
        else
        {
            mantenimiento = new MantenimientoAutobus { Estado = EstadoMantenimiento.Programado };
        }
    }

    private void CargarDatos()
    {
        // TODO: Cargar desde base de datos
        autobuses = new List<Autobus>
        {
            new Autobus { Id = 1, Matricula = "1234-ABC", Marca = "Mercedes", Modelo = "Tourismo" }
        };
    }

    private void Guardar()
    {
        mantenimiento.FechaInicio = fechaInicio;
        mantenimiento.FechaFin = fechaFin;
        // TODO: Guardar en base de datos
        NavigationManager.NavigateTo("/mantenimiento");
    }

    private void Volver()
    {
        NavigationManager.NavigateTo("/mantenimiento");
    }
}
