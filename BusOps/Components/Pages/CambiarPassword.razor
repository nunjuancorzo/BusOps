@page "/cambiar-password"
@using BusOps.Data
@using BusOps.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject IDbContextFactory<BusOpsDbContext> DbFactory
@inject IJSRuntime JSRuntime
@inject ProtectedSessionStorage SessionStorage
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Cambiar Contraseña</PageTitle>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header" style="background-color: #003366; color: white;">
                    <h4 class="mb-0">
                        <i class="bi bi-key-fill me-2"></i>Cambiar Contraseña
                    </h4>
                </div>
                <div class="card-body p-4">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>@errorMessage
                            <button type="button" class="btn-close" @onclick='() => errorMessage = null'></button>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle-fill me-2"></i>@successMessage
                            <button type="button" class="btn-close" @onclick='() => successMessage = null'></button>
                        </div>
                    }

                    @if (usuario != null)
                    {
                        <div class="mb-4 p-3" style="background-color: #f8f9fa; border-radius: 8px;">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-circle" style="font-size: 3rem; color: #003366;"></i>
                                <div class="ms-3">
                                    <h5 class="mb-1">@usuario.NombreCompleto</h5>
                                    <p class="text-muted mb-0">@usuario.Username</p>
                                    <p class="text-muted mb-0"><small>@usuario.Email</small></p>
                                </div>
                            </div>
                        </div>

                        <form @onsubmit="ProcesarCambioPassword">
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-lock-fill me-2"></i>Contraseña Actual
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="password" 
                                       class="form-control" 
                                       @bind="passwordActual" 
                                       placeholder="Ingrese su contraseña actual"
                                       required />
                                <small class="text-muted">Debe ingresar su contraseña actual para verificar su identidad</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-key me-2"></i>Nueva Contraseña
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="password" 
                                       class="form-control" 
                                       @bind="passwordNueva" 
                                       placeholder="Ingrese su nueva contraseña"
                                       required />
                                <small class="text-muted">Mínimo 4 caracteres</small>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-key-fill me-2"></i>Confirmar Nueva Contraseña
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="password" 
                                       class="form-control" 
                                       @bind="passwordConfirmacion" 
                                       placeholder="Confirme su nueva contraseña"
                                       required />
                            </div>

                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                <strong>Consejos de seguridad:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Use una contraseña única que no utilice en otros sitios</li>
                                    <li>Combine letras, números y símbolos</li>
                                    <li>No comparta su contraseña con nadie</li>
                                </ul>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary" disabled="@isLoading">
                                    @if (isLoading)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        <span>Cambiando contraseña...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-check-circle me-2"></i>
                                        <span>Cambiar Contraseña</span>
                                    }
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="Volver">
                                    <i class="bi bi-arrow-left me-2"></i>Volver
                                </button>
                            </div>
                        </form>
                    }
                    else
                    {
                        <div class="text-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-3 text-muted">Cargando información del usuario...</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private Usuario? usuario;
    private string passwordActual = string.Empty;
    private string passwordNueva = string.Empty;
    private string passwordConfirmacion = string.Empty;
    private string? errorMessage;
    private string? successMessage;
    private bool isLoading = false;
    private int? userId;

    protected override async Task OnInitializedAsync()
    {
        await VerificarAutenticacion();
    }

    private async Task VerificarAutenticacion()
    {
        try
        {
            var resultAuth = await SessionStorage.GetAsync<bool>("isAuthenticated");
            var resultUserId = await SessionStorage.GetAsync<int>("userId");

            if (!resultAuth.Success || !resultAuth.Value || !resultUserId.Success)
            {
                NavigationManager.NavigateTo("/login", true);
                return;
            }

            userId = resultUserId.Value;
            await CargarUsuario();
        }
        catch
        {
            NavigationManager.NavigateTo("/login", true);
        }
    }

    private async Task CargarUsuario()
    {
        if (!userId.HasValue) return;

        try
        {
            using var context = await DbFactory.CreateDbContextAsync();
            // Ignorar filtros para poder cargar cualquier usuario sin restricciones multi-tenant
            usuario = await context.Usuarios
                .IgnoreQueryFilters()
                .FirstOrDefaultAsync(u => u.Id == userId.Value);
            
            StateHasChanged(); // Forzar actualización de la UI
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar usuario: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task ProcesarCambioPassword()
    {
        errorMessage = null;
        successMessage = null;
        isLoading = true;

        try
        {
            // Validaciones
            if (string.IsNullOrWhiteSpace(passwordActual))
            {
                errorMessage = "Debe ingresar su contraseña actual";
                isLoading = false;
                return;
            }

            if (string.IsNullOrWhiteSpace(passwordNueva))
            {
                errorMessage = "Debe ingresar una nueva contraseña";
                isLoading = false;
                return;
            }

            if (passwordNueva.Length < 4)
            {
                errorMessage = "La nueva contraseña debe tener al menos 4 caracteres";
                isLoading = false;
                return;
            }

            if (passwordNueva != passwordConfirmacion)
            {
                errorMessage = "Las contraseñas no coinciden";
                isLoading = false;
                return;
            }

            if (passwordActual == passwordNueva)
            {
                errorMessage = "La nueva contraseña debe ser diferente a la actual";
                isLoading = false;
                return;
            }

            using var context = await DbFactory.CreateDbContextAsync();
            
            // Verificar contraseña actual (ignorar filtros multi-tenant)
            var usuarioDB = await context.Usuarios
                .IgnoreQueryFilters()
                .FirstOrDefaultAsync(u => u.Id == userId!.Value);
            
            if (usuarioDB == null)
            {
                errorMessage = "Usuario no encontrado";
                isLoading = false;
                return;
            }

            if (usuarioDB.Password != passwordActual)
            {
                errorMessage = "La contraseña actual es incorrecta";
                isLoading = false;
                return;
            }

            // Actualizar contraseña
            usuarioDB.Password = passwordNueva;
            await context.SaveChangesAsync();

            successMessage = "¡Contraseña cambiada exitosamente!";
            
            // Limpiar campos
            passwordActual = string.Empty;
            passwordNueva = string.Empty;
            passwordConfirmacion = string.Empty;

            // Opcional: Redirigir después de unos segundos
            await Task.Delay(2000);
            NavigationManager.NavigateTo("/");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cambiar la contraseña: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void Volver()
    {
        NavigationManager.NavigateTo("/");
    }
}
